// app/(dashboard)/schedule/page.tsx
'use client'

import { useState, useEffect } from 'react'
import { Calendar, Target, Clock, AlertCircle, TrendingUp, Play, Settings, FileText, Bell, Sparkles, RefreshCw } from 'lucide-react'
import { format } from 'date-fns'
import { ja } from 'date-fns/locale'
import Link from 'next/link'
import { motion } from 'framer-motion'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { useAuth } from '@/hooks/use-auth'


interface Schedule {
  id: string
  targetDate: string
  targetScore: number
  currentScore: number
  status: 'on_track' | 'slightly_behind' | 'behind'
  progress: {
    totalDays: number
    elapsedDays: number
    remainingDays: number
    totalStudyHours: number
    expectedHours: number
    percentage: number
  }
  monthlyGoals: {
    id: string
    month: number
    year: number
    totalHours: number
    subjectGoals: {
      subject: string
      targetHours: number
      topics: string[]
      priority: string
    }[]
  }[]
  nextMilestone?: {
    title: string
    startDate: string
    type: string
  }
}

interface TodayTask {
  id: string
  subject: string
  topic: string
  startTime: string
  duration: number
  status: 'not_started' | 'in_progress' | 'completed'
  icon: string
}

// ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
const mockSchedule: Schedule = {
  id: '1',
  targetDate: '2025-03-15',
  targetScore: 80,
  currentScore: 60,
  status: 'on_track',
  progress: {
    totalDays: 180,
    elapsedDays: 45,
    remainingDays: 135,
    totalStudyHours: 120,
    expectedHours: 115,
    percentage: 25
  },
  monthlyGoals: [
    {
      id: '1',
      month: 7,
      year: 2025,
      totalHours: 120,
      subjectGoals: [
        {
          subject: 'è‹±èª',
          targetHours: 40,
          topics: ['é•·æ–‡èª­è§£', 'æ–‡æ³•', 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°'],
          priority: 'high'
        },
        {
          subject: 'æ•°å­¦',
          targetHours: 35,
          topics: ['å¾®åˆ†ç©åˆ†', 'ç¢ºç‡çµ±è¨ˆ', 'ãƒ™ã‚¯ãƒˆãƒ«'],
          priority: 'high'
        },
        {
          subject: 'å›½èª',
          targetHours: 25,
          topics: ['ç¾ä»£æ–‡', 'å¤æ–‡', 'æ¼¢æ–‡'],
          priority: 'medium'
        },
        {
          subject: 'ç†ç§‘',
          targetHours: 20,
          topics: ['ç‰©ç†', 'åŒ–å­¦'],
          priority: 'medium'
        }
      ]
    }
  ],
  nextMilestone: {
    title: 'æ¨¡æ“¬è©¦é¨“',
    startDate: '2025-08-10',
    type: 'exam'
  }
}

export default function SchedulePage() {
  const { user, loading: authLoading } = useAuth()
  const [schedule, setSchedule] = useState<Schedule | null>(null)
  const [loading, setLoading] = useState(true)
  const [adjusting, setAdjusting] = useState(false)
  
  const [todayTasks] = useState<TodayTask[]>([
    {
      id: '1',
      subject: 'è‹±èª',
      topic: 'é•·æ–‡èª­è§£æ¼”ç¿’',
      startTime: '09:00',
      duration: 90,
      status: 'not_started',
      icon: 'ğŸ“˜'
    },
    {
      id: '2',
      subject: 'æ•°å­¦',
      topic: 'å¾®åˆ†ç©åˆ†',
      startTime: '15:00',
      duration: 60,
      status: 'not_started',
      icon: 'ğŸ”µ'
    },
    {
      id: '3',
      subject: 'ç‰©ç†',
      topic: 'åŠ›å­¦ï¼ˆé‹å‹•æ–¹ç¨‹å¼ï¼‰',
      startTime: '17:00',
      duration: 60,
      status: 'not_started',
      icon: 'âš¡'
    }
  ])

  useEffect(() => {
    if (!authLoading && user) {
      fetchSchedule()
    } else if (!authLoading && !user) {
      setLoading(false)
    }
  }, [authLoading, user])

  const fetchSchedule = async () => {
    if (!user) return
    
    try {
      const token = await user.getIdToken()
      const response = await fetch('/api/schedule/firebase', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      
      if (response.ok) {
        const data = await response.json()
        setSchedule(data)
      } else {
        // APIãŒã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        console.log('APIã‚¨ãƒ©ãƒ¼ã€ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨')
        setSchedule(mockSchedule)
      }
    } catch (error) {
      console.error('Error fetching schedule:', error)
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      setSchedule(mockSchedule)
    } finally {
      setLoading(false)
    }
  }

  const handleAdjustSchedule = async () => {
    if (!schedule) return
    
    setAdjusting(true)
    // TODO: å®Ÿéš›ã®APIã«ç½®ãæ›ãˆã‚‹
    setTimeout(() => {
      console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰')
      setAdjusting(false)
    }, 2000)
  }

  const handleStartStudy = (taskId: string) => {
    // å­¦ç¿’é–‹å§‹ã®å‡¦ç†
    console.log('Starting study for task:', taskId)
    window.location.href = '/study?taskId=' + taskId
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'on_track':
        return 'text-green-600 bg-green-50'
      case 'slightly_behind':
        return 'text-yellow-600 bg-yellow-50'
      case 'behind':
        return 'text-red-600 bg-red-50'
      default:
        return 'text-gray-600 bg-gray-50'
    }
  }

  const getStatusText = (status: string) => {
    switch (status) {
      case 'on_track':
        return 'é †èª¿'
      case 'slightly_behind':
        return 'ã‚„ã‚„é…ã‚Œ'
      case 'behind':
        return 'é…ã‚Œã‚ã‚Š'
      default:
        return 'ä¸æ˜'
    }
  }

  if (loading || authLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    )
  }

  if (!user) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className="text-center py-12">
          <h2 className="text-2xl font-bold mb-4">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
          <p className="text-gray-600 mb-6">
            ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
          </p>
          <Link href="/login">
            <Button size="lg">ãƒ­ã‚°ã‚¤ãƒ³</Button>
          </Link>
        </div>
      </div>
    )
  }

  if (!schedule) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className="text-center py-12">
          <h2 className="text-2xl font-bold mb-4">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
          <p className="text-gray-600 mb-6">
            AIãŒæœ€é©ãªå­¦ç¿’è¨ˆç”»ã‚’ä½œæˆã—ã¾ã™
          </p>
          <Link href="/schedule/create">
            <Button size="lg" className="gap-2">
              <Sparkles className="h-5 w-5" />
              å­¦ç¿’è¨ˆç”»ã‚’ä½œæˆ
            </Button>
          </Link>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="mb-6 flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold mb-2">å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
          <p className="text-gray-600">
            ç›®æ¨™ã¾ã§ã‚ã¨{schedule.progress.remainingDays}æ—¥
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={handleAdjustSchedule}
            disabled={adjusting}
            className="gap-2"
          >
            {adjusting ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600"></div>
                èª¿æ•´ä¸­...
              </>
            ) : (
              <>
                <RefreshCw className="h-4 w-4" />
                ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´
              </>
            )}
          </Button>
          <Link href="/schedule/edit">
            <Button variant="outline" size="sm" className="gap-2">
              <Settings className="h-4 w-4" />
              è¨­å®š
            </Button>
          </Link>
        </div>
      </div>

      {/* é€²æ—ã‚µãƒãƒªãƒ¼ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-lg">å­¦ç¿’é€²æ—</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between mb-2">
              <span className="text-2xl font-bold">
                {schedule.progress.percentage}%
              </span>
              <Badge className={getStatusColor(schedule.status)}>
                {getStatusText(schedule.status)}
              </Badge>
            </div>
            <Progress value={schedule.progress.percentage} className="h-2" />
            <p className="text-sm text-gray-600 mt-2">
              {schedule.progress.totalStudyHours.toFixed(1)}æ™‚é–“ / 
              {schedule.progress.expectedHours.toFixed(1)}æ™‚é–“
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-lg">æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</CardTitle>
          </CardHeader>
          <CardContent>
            {schedule.nextMilestone ? (
              <div>
                <p className="font-medium">{schedule.nextMilestone.title}</p>
                <p className="text-sm text-gray-600">
                  {format(new Date(schedule.nextMilestone.startDate), 'Mæœˆdæ—¥', { locale: ja })}
                </p>
                <Badge variant="outline" className="mt-2">
                  {schedule.nextMilestone.type}
                </Badge>
              </div>
            ) : (
              <p className="text-gray-500">è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-lg">ç›®æ¨™ã‚¹ã‚³ã‚¢</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-baseline gap-2 mb-2">
              <span className="text-2xl font-bold">{schedule.targetScore}%</span>
              <span className="text-sm text-gray-600">
                (ç¾åœ¨: {schedule.currentScore}%)
              </span>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <TrendingUp className="h-4 w-4 text-green-600" />
              <span className="text-green-600">
                +{schedule.targetScore - schedule.currentScore}%å‘ä¸ŠãŒå¿…è¦
              </span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* ã‚¿ãƒ– */}
      <Tabs defaultValue="today" className="space-y-4">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="today">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</TabsTrigger>
          <TabsTrigger value="calendar">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</TabsTrigger>
          <TabsTrigger value="monthly">æœˆé–“ç›®æ¨™</TabsTrigger>
        </TabsList>

        <TabsContent value="today">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Calendar className="h-5 w-5" />
                ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯
              </CardTitle>
              <CardDescription>
                {format(new Date(), 'Mæœˆdæ—¥ï¼ˆEï¼‰', { locale: ja })}
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {todayTasks.map((task, index) => (
                  <motion.div
                    key={task.id}
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className={`p-3 rounded-lg border ${
                      task.status === 'completed' ? 'bg-green-50 border-green-200' :
                      task.status === 'in_progress' ? 'bg-blue-50 border-blue-200' :
                      'bg-white border-gray-200'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">{task.icon}</span>
                        <div>
                          <h4 className="font-medium">{task.subject}</h4>
                          <p className="text-sm text-gray-600">{task.topic}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-sm font-medium">{task.startTime}</p>
                        <p className="text-xs text-gray-500">{task.duration}åˆ†</p>
                      </div>
                    </div>
                    {task.status === 'not_started' && (
                      <Button
                        size="sm"
                        className="w-full mt-2"
                        onClick={() => handleStartStudy(task.id)}
                      >
                        <Play className="h-4 w-4 mr-1" />
                        å­¦ç¿’ã‚’é–‹å§‹
                      </Button>
                    )}
                    {task.status === 'in_progress' && (
                      <Badge className="mt-2" variant="default">
                        å­¦ç¿’ä¸­
                      </Badge>
                    )}
                    {task.status === 'completed' && (
                      <Badge className="mt-2" variant="secondary">
                        å®Œäº†
                      </Badge>
                    )}
                  </motion.div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="calendar">
        </TabsContent>

        <TabsContent value="monthly">
          <Card>
            <CardHeader>
              <CardTitle>æœˆé–“å­¦ç¿’ç›®æ¨™</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {schedule.monthlyGoals
                  .filter(goal => {
                    const now = new Date()
                    return goal.year === now.getFullYear() && 
                           goal.month === now.getMonth() + 1
                  })
                  .map(goal => (
                    <div key={goal.id} className="p-4 bg-gray-50 rounded-lg">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="font-medium">
                          {goal.year}å¹´{goal.month}æœˆ
                        </h3>
                        <Badge>
                          ç›®æ¨™: {goal.totalHours}æ™‚é–“
                        </Badge>
                      </div>
                      <div className="space-y-2">
                        {goal.subjectGoals.map(subject => (
                          <div key={subject.subject} className="flex items-center justify-between">
                            <span className="text-sm">{subject.subject}</span>
                            <div className="flex items-center gap-2">
                              <span className="text-sm text-gray-600">
                                {subject.targetHours}æ™‚é–“
                              </span>
                              <Badge variant="outline" className="text-xs">
                                {subject.priority}
                              </Badge>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  )
}