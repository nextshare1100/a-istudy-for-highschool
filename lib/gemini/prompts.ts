// lib/gemini/prompts.ts - 全教科完全対応版（修正版）

import {
  GeminiProblemRequest,
} from '@/types/gemini';

// 全教科の単元・トピック完全データベース
const UNIT_TOPICS_DATABASE = {
  // ========== 数学 ==========
  '数学Ⅰ': {
    '数と式': [
      '式の計算（展開・因数分解）',
      '実数（有理数・無理数・絶対値）',
      '一次不等式',
      '連立不等式',
      '集合',
      '命題と論理',
      '必要条件・十分条件'
    ],
    '二次関数': [
      '二次関数のグラフ',
      '平行移動・対称移動',
      '最大値・最小値',
      '二次方程式',
      '判別式',
      '解と係数の関係',
      '二次不等式',
      '二次関数の決定'
    ],
    '図形と計量': [
      '三角比の定義',
      '三角比の相互関係',
      '三角比の拡張',
      '正弦定理',
      '余弦定理',
      '三角形の面積',
      '空間図形への応用'
    ],
    'データの分析': [
      '度数分布とヒストグラム',
      '代表値（平均・中央値・最頻値）',
      '四分位数と箱ひげ図',
      '分散と標準偏差',
      '散布図と相関',
      '相関係数',
      '仮説検定の考え方'
    ]
  },
  
  '数学A': {
    '場合の数と確率': [
      '集合の要素の個数',
      '場合の数',
      '順列',
      '組合せ',
      '二項定理',
      '事象と確率',
      '確率の基本性質',
      '独立試行',
      '条件付き確率',
      '期待値'
    ],
    '整数の性質': [
      '約数と倍数',
      '素因数分解',
      '最大公約数・最小公倍数',
      'ユークリッドの互除法',
      '一次不定方程式',
      '合同式',
      'n進法'
    ],
    '図形の性質': [
      '三角形の性質',
      '三角形の五心',
      'チェバの定理',
      'メネラウスの定理',
      '円の性質',
      '円周角の定理',
      '方べきの定理',
      '作図'
    ]
  },
  
  '数学Ⅱ': {
    '式と証明': [
      '三次式の展開と因数分解',
      '二項定理',
      '整式の除法',
      '分数式',
      '恒等式',
      '等式の証明',
      '不等式の証明',
      '相加相乗平均'
    ],
    '複素数と方程式': [
      '複素数の計算',
      '複素数平面',
      '二次方程式の解',
      '解と係数の関係',
      '剰余の定理・因数定理',
      '高次方程式'
    ],
    '図形と方程式': [
      '点と直線',
      '直線の方程式',
      '円の方程式',
      '円と直線',
      '軌跡と領域',
      '不等式の表す領域'
    ],
    '三角関数': [
      '一般角と弧度法',
      '三角関数の定義',
      '三角関数のグラフ',
      '三角関数の基本公式',
      '加法定理',
      '倍角・半角の公式',
      '三角関数の合成',
      '三角方程式・不等式'
    ],
    '指数関数・対数関数': [
      '指数法則',
      '指数関数のグラフ',
      '指数方程式・不等式',
      '対数の定義と性質',
      '対数関数のグラフ',
      '常用対数',
      '対数方程式・不等式'
    ],
    '微分・積分': [
      '微分係数と導関数',
      '導関数の計算',
      '接線の方程式',
      '関数の増減',
      '極大・極小',
      '最大・最小',
      '不定積分',
      '定積分',
      '面積'
    ]
  },
  
  '数学B': {
    '数列': [
      '等差数列',
      '等比数列',
      '和の記号Σ',
      '階差数列',
      '数列の和',
      '漸化式',
      '数学的帰納法',
      '二項間漸化式',
      '三項間漸化式'
    ],
    'ベクトル': [
      'ベクトルの演算',
      '位置ベクトル',
      'ベクトルの内積',
      '直線のベクトル方程式',
      '平面のベクトル方程式',
      '空間ベクトル',
      '空間における直線と平面'
    ],
    '統計的な推測': [
      '確率変数と確率分布',
      '二項分布',
      '正規分布',
      '母集団と標本',
      '推定',
      '仮説検定',
      '相関と回帰'
    ]
  },
  
  '数学Ⅲ': {
    '極限': [
      '数列の極限',
      '無限等比数列',
      '無限級数',
      '関数の極限',
      '三角関数の極限',
      '関数の連続性'
    ],
    '微分法': [
      '導関数の定義',
      '積・商の微分',
      '合成関数の微分',
      '三角関数の導関数',
      '指数・対数関数の導関数',
      '高次導関数',
      '平均値の定理',
      'テイラー展開'
    ],
    '積分法': [
      '不定積分の計算',
      '置換積分',
      '部分積分',
      '有理関数の積分',
      '三角関数の積分',
      '定積分の計算',
      '面積',
      '体積',
      '曲線の長さ'
    ]
  },
  
  // ========== 物理 ==========
  '物理基礎': {
    '運動とエネルギー': [
      '速度と加速度',
      '等速直線運動',
      '等加速度運動',
      '落体の運動',
      '力のつりあい',
      '運動の法則',
      '摩擦力',
      '仕事とエネルギー',
      '力学的エネルギー保存'
    ],
    '熱': [
      '温度と熱',
      '熱量',
      '比熱と熱容量',
      '熱の移動',
      '物質の三態',
      '熱膨張',
      'エネルギーの変換'
    ],
    '波': [
      '波の性質',
      '波の表し方',
      '音波',
      '音の三要素',
      'うなり',
      '弦の振動',
      '気柱の振動'
    ],
    '電気': [
      '静電気',
      '電流と電圧',
      '電気抵抗',
      'オームの法則',
      '電力',
      '電流の熱作用',
      '電流の磁気作用'
    ]
  },
  
  '物理': {
    '力学': [
      '運動量と力積',
      '運動量保存則',
      '反発係数',
      '円運動',
      '単振動',
      '万有引力',
      'ケプラーの法則',
      '慣性力',
      '剛体の運動'
    ],
    '熱力学': [
      '気体の法則',
      '理想気体の状態方程式',
      '気体分子運動論',
      '内部エネルギー',
      '熱力学第一法則',
      '熱機関',
      '熱力学第二法則',
      'エントロピー'
    ],
    '波動': [
      '波の干渉',
      '定常波',
      '波の反射・屈折',
      '回折',
      'ドップラー効果',
      '光の性質',
      '光の干渉',
      '光の回折',
      'レンズ',
      '光学機器'
    ],
    '電磁気': [
      '電場',
      'ガウスの法則',
      '電位',
      'コンデンサー',
      '誘電体',
      '磁場',
      'ローレンツ力',
      '電磁誘導',
      '自己誘導・相互誘導',
      '交流',
      '電磁波'
    ],
    '原子': [
      '電子の発見',
      '光電効果',
      '物質波',
      'ボーアの原子模型',
      'X線',
      '放射線',
      '原子核',
      '核反応',
      '素粒子'
    ]
  },
  
  // ========== 化学 ==========
  '化学基礎': {
    '物質の構成': [
      '純物質と混合物',
      '元素と単体・化合物',
      '原子の構造',
      '電子配置',
      'イオンの生成',
      '周期表',
      '化学結合',
      '結晶'
    ],
    '物質の変化': [
      '原子量・分子量・式量',
      '物質量（モル）',
      '化学反応式',
      '化学反応の量的関係',
      '酸と塩基',
      '中和反応',
      'pH',
      '酸化還元反応',
      'イオン化傾向',
      '電池'
    ]
  },
  
  '化学': {
    '物質の状態': [
      '物質の三態',
      '気体の法則',
      '理想気体と実在気体',
      '蒸気圧',
      '状態図',
      '溶解度',
      '希薄溶液の性質',
      'コロイド'
    ],
    '熱化学': [
      '反応熱',
      'ヘスの法則',
      '生成熱',
      '結合エネルギー',
      '溶解熱',
      '中和熱'
    ],
    '反応速度と平衡': [
      '反応速度',
      '反応速度式',
      '活性化エネルギー',
      '触媒',
      '化学平衡',
      '平衡定数',
      'ルシャトリエの原理',
      '電離平衡',
      '溶解度積'
    ],
    '無機化学': [
      '水素と希ガス',
      'ハロゲン',
      '酸素・硫黄',
      '窒素・リン',
      '炭素・ケイ素',
      'アルカリ金属',
      'アルカリ土類金属',
      '両性元素',
      '遷移元素',
      '錯イオン'
    ],
    '有機化学': [
      '有機化合物の特徴',
      '炭化水素',
      'アルコールとエーテル',
      'アルデヒドとケトン',
      'カルボン酸とエステル',
      '油脂とセッケン',
      '芳香族化合物',
      'フェノール類',
      'アニリン',
      '高分子化合物'
    ]
  },
  
  // ========== 生物 ==========
  '生物基礎': {
    '生物の特徴': [
      '生物の共通性',
      '細胞の構造',
      '細胞膜の性質',
      '酵素',
      '光合成',
      '呼吸',
      'ミトコンドリアと葉緑体'
    ],
    '遺伝子とその働き': [
      'DNAの構造',
      '遺伝情報とDNA',
      '遺伝情報の複製',
      '遺伝情報の発現',
      'タンパク質の合成',
      '遺伝子の発現調節',
      '突然変異'
    ],
    '生物の体内環境': [
      '体液',
      '血液の循環',
      '肝臓の働き',
      '腎臓の働き',
      '神経系',
      '内分泌系',
      '免疫',
      'ホメオスタシス'
    ],
    '生物の多様性と生態系': [
      '植生',
      '遷移',
      'バイオーム',
      '生態系の構造',
      '物質循環',
      'エネルギーの流れ',
      '生物多様性',
      '環境問題'
    ]
  },
  
  '生物': {
    '生命現象と物質': [
      'タンパク質の構造と性質',
      '酵素の性質',
      '細胞膜の構造と機能',
      '細胞内輸送',
      '代謝',
      'ATP',
      '光合成の詳細',
      '呼吸の詳細'
    ],
    '遺伝子の発現調節': [
      '真核生物の遺伝子発現',
      '原核生物の遺伝子発現',
      '発生と遺伝子発現',
      'ホメオティック遺伝子',
      'バイオテクノロジー',
      'PCR法',
      '遺伝子組換え',
      'ゲノム解析'
    ],
    '生殖と発生': [
      '無性生殖と有性生殖',
      '減数分裂',
      '配偶子形成',
      '受精',
      '初期発生',
      '器官形成',
      '植物の発生',
      '形態形成'
    ],
    '生物の環境応答': [
      '刺激の受容',
      '神経系の構造と機能',
      '効果器',
      '動物の行動',
      '植物の環境応答',
      '植物ホルモン',
      '光周性',
      '生物時計'
    ],
    '生態と環境': [
      '個体群',
      '生物群集',
      '生態系の物質生産',
      '生態系のエネルギー効率',
      '生物間相互作用',
      '生態系のバランス',
      '保全生物学'
    ],
    '進化と系統': [
      '生命の起源',
      '生物の変遷',
      '進化のしくみ',
      '種分化',
      '系統と分類',
      '人類の進化'
    ]
  },
  
  // ========== 地学 ==========
  '地学基礎': {
    '宇宙の構成': [
      '太陽系の構造',
      '太陽系の誕生',
      '太陽',
      '惑星',
      '小天体',
      '恒星',
      '銀河系',
      '宇宙の構造'
    ],
    '地球の構成と変動': [
      '地球の形と大きさ',
      '地球の内部構造',
      'プレートテクトニクス',
      '地震',
      '火山',
      '地層',
      '地質時代',
      '古生物'
    ],
    '大気と海洋': [
      '大気の構造',
      '大気の循環',
      '天気',
      '日本の天気',
      '海洋の構造',
      '海流',
      '大気と海洋の相互作用'
    ],
    '地球環境': [
      '地球環境の変遷',
      '地球温暖化',
      'オゾン層',
      '酸性雨',
      '自然災害',
      '防災'
    ]
  },
  
  // ========== 英語 ==========
  '英語': {
    '英文法': [
      '文型（SV, SVC, SVO, SVOO, SVOC）',
      '時制（現在・過去・未来）',
      '完了形（現在完了・過去完了・未来完了）',
      '進行形',
      '助動詞（can, will, must, should, may）',
      '受動態',
      '不定詞（名詞用法・形容詞用法・副詞用法）',
      '動名詞',
      '分詞（現在分詞・過去分詞）',
      '分詞構文',
      '関係代名詞（who, which, that）',
      '関係副詞（when, where, why, how）',
      '比較（原級・比較級・最上級）',
      '仮定法（仮定法過去・仮定法過去完了）',
      '接続詞（等位接続詞・従位接続詞）',
      '前置詞',
      '冠詞（a, an, the）',
      '代名詞',
      '話法（直接話法・間接話法）',
      '否定',
      '疑問文',
      '強調・倒置・省略'
    ],
    '英作文': [
      '基礎和文英訳',
      '応用和文英訳',
      '自由英作文（意見論述）',
      '自由英作文（説明・描写）',
      '自由英作文（グラフ・図表説明）',
      '自由英作文（写真描写）',
      'エッセイライティング（序論・本論・結論）',
      'パラグラフライティング',
      '要約作文',
      '条件英作文',
      'メール・手紙文',
      'ディベート・ディスカッション用英文'
    ],
    '長文読解': [
      '主題・要旨の把握',
      '段落構成の理解',
      '論理展開の追跡',
      '内容一致問題',
      '空所補充（文脈把握）',
      '下線部説明',
      '指示語の内容',
      '語句の意味推測',
      '筆者の主張・意見',
      '文章の要約',
      '推論・推測',
      'パラグラフ整序'
    ],
    '単語': [
      '基本語彙（2000語レベル）',
      '標準語彙（4000語レベル）',
      '発展語彙（6000語レベル）',
      '最上級語彙（8000語以上）',
      '同義語・類義語',
      '反意語',
      '派生語',
      '熟語・慣用表現',
      'コロケーション',
      '句動詞',
      '前置詞句',
      'アクセント・発音'
    ]
  },
  
  // ========== 国語 ==========
  '現代文': {
    '文法': [
      '品詞分類（動詞・形容詞・形容動詞等）',
      '文の成分（主語・述語・修飾語等）',
      '敬語（尊敬語・謙譲語・丁寧語）',
      '文体（常体・敬体）',
      '修辞技法（比喩・擬人法・倒置等）',
      '接続詞・接続助詞',
      '助詞の用法',
      '助動詞の用法',
      '副詞の用法',
      '文章構成法'
    ],
    '読解': [
      '論説文（論理展開）',
      '評論文（筆者の主張）',
      '小説（心情・場面・人物）',
      '随筆（筆者の体験と感想）',
      '詩歌の鑑賞',
      '要約・要旨',
      '段落関係',
      '指示語・接続語',
      '表現技法と効果',
      '文章の構成と展開'
    ],
    '単語': [
      '漢字の読み（常用漢字）',
      '漢字の書き（常用漢字）',
      '熟語の構成',
      '四字熟語',
      '慣用句',
      'ことわざ',
      '類義語・対義語',
      '同音異義語・同訓異字',
      '現代語の語彙',
      'カタカナ語・外来語'
    ]
  },
  
  '古文': {
    '文法': [
      '歴史的仮名遣い',
      '動詞の活用（四段・上下段等）',
      '形容詞の活用（ク活用・シク活用）',
      '形容動詞の活用（ナリ活用・タリ活用）',
      '助動詞（完了・過去・推量・推定等）',
      '助詞（格助詞・接続助詞・終助詞・副助詞）',
      '敬語法（尊敬・謙譲・丁寧）',
      '係り結び',
      '品詞分解',
      '主語の判定'
    ],
    '読解': [
      '物語（源氏物語・竹取物語・伊勢物語等）',
      '随筆（枕草子・徒然草・方丈記）',
      '日記（土佐日記・更級日記・紫式部日記）',
      '説話（今昔物語・宇治拾遺物語）',
      '軍記（平家物語・太平記）',
      '和歌の解釈',
      '主題把握',
      '人物関係',
      '心情理解',
      '古文常識'
    ],
    '単語': [
      '基本古語（300語）',
      '重要古語（600語）',
      '最重要古語（1000語）',
      '多義語',
      '同音異義語',
      '敬語動詞',
      '助動詞の意味',
      '助詞の意味',
      '和歌の修辞（掛詞・縁語・枕詞）',
      '古文常識語彙'
    ]
  },
  
  '漢文': {
    '文法': [
      '返り点（レ点・一二点・上下点）',
      '送り仮名',
      '書き下し文',
      '返読文字',
      '再読文字',
      '使役形',
      '受身形',
      '否定形',
      '疑問形・反語形',
      '仮定形',
      '比較形',
      '抑揚形',
      '限定形',
      '詠嘆形'
    ],
    '読解': [
      '思想（論語・孟子・老子・荘子）',
      '史伝（史記・十八史略・戦国策）',
      '詩（唐詩・宋詩）',
      '文章（古文真宝・文選）',
      '寓話・説話',
      '主題把握',
      '論理展開',
      '人物評価',
      '故事成語の由来',
      '漢詩の鑑賞'
    ],
    '単語': [
      '基本漢字（500字）',
      '重要漢字（1000字）',
      '最重要漢字（1500字）',
      '同形異義語',
      '熟語の構成',
      '故事成語',
      '漢文特有語',
      '官職名・人名・地名',
      '文化・習慣語',
      '漢詩の用語'
    ]
  },
  
  // ========== 社会 ==========
  '日本史': {
    '原始・古代': [
      '旧石器時代',
      '縄文時代',
      '弥生時代',
      '古墳時代',
      '飛鳥時代（推古朝・大化改新）',
      '奈良時代（平城京・天平文化）',
      '平安時代前期（平安京・摂関政治）',
      '平安時代後期（院政・平氏政権）'
    ],
    '中世': [
      '鎌倉幕府の成立',
      '執権政治',
      '元寇と幕府の衰退',
      '建武の新政',
      '室町幕府の成立',
      '南北朝の動乱',
      '室町幕府の発展',
      '応仁の乱と戦国時代'
    ],
    '近世': [
      '織豊政権（信長・秀吉）',
      '江戸幕府の成立',
      '幕藩体制の確立',
      '鎖国政策',
      '幕政改革（享保・寛政・天保）',
      '町人文化（元禄・化政）',
      '幕末の動乱'
    ],
    '近代': [
      '明治維新',
      '富国強兵・殖産興業',
      '自由民権運動',
      '大日本帝国憲法',
      '日清・日露戦争',
      '大正デモクラシー',
      '昭和恐慌と軍部台頭',
      '第二次世界大戦'
    ],
    '現代': [
      '占領と改革',
      '日本国憲法',
      '独立回復と55年体制',
      '高度経済成長',
      'オイルショックと安定成長',
      'バブル経済と崩壊',
      '平成・令和の日本'
    ]
  },
  
  '世界史': {
    '古代文明': [
      'オリエント文明（メソポタミア・エジプト）',
      'ギリシア文明（ポリス・ヘレニズム）',
      'ローマ文明（共和政・帝政）',
      'インド文明（インダス・アーリア人）',
      '中国文明（殷・周・春秋戦国）',
      '秦漢帝国',
      '魏晋南北朝',
      '隋唐帝国'
    ],
    '中世': [
      'ビザンツ帝国',
      'イスラーム世界の成立と発展',
      '中世ヨーロッパ（封建制・十字軍）',
      'モンゴル帝国',
      '宋・元・明',
      '東南アジア諸国',
      'アフリカ諸王国'
    ],
    '近世': [
      'ルネサンス',
      '大航海時代',
      '宗教改革',
      '絶対王政',
      'オスマン帝国',
      'ムガル帝国',
      '清朝',
      '江戸時代の日本'
    ],
    '近代': [
      '市民革命（イギリス・アメリカ・フランス）',
      '産業革命',
      'ナポレオン時代',
      'ウィーン体制と国民国家',
      '帝国主義',
      '第一次世界大戦',
      'ロシア革命',
      'ヴェルサイユ体制'
    ],
    '現代': [
      '世界恐慌とファシズム',
      '第二次世界大戦',
      '冷戦',
      '第三世界の台頭',
      '冷戦の終結',
      'グローバル化',
      '現代の諸問題'
    ]
  },
  
  '地理': {
    '自然環境': [
      '地形（山地・平野・海岸）',
      '気候（気候区分・気候要素）',
      '植生と土壌',
      '水文（河川・湖沼・地下水）',
      '自然災害（地震・火山・気象災害）',
      '環境問題'
    ],
    '資源と産業': [
      '農業（農業地域・農産物）',
      '林業・水産業',
      '鉱工業（工業地域・工業製品）',
      'エネルギー資源',
      '商業・サービス業',
      '交通・通信'
    ],
    '人口と都市': [
      '人口分布と人口移動',
      '人口問題',
      '都市化と都市問題',
      '村落',
      '生活文化'
    ],
    '地誌': [
      '日本地誌',
      '東アジア',
      '東南アジア・南アジア',
      '西アジア・アフリカ',
      'ヨーロッパ',
      'アメリカ',
      'オセアニア'
    ]
  },
  
  '倫理': {
    '源流思想': [
      '古代ギリシア思想（ソクラテス・プラトン・アリストテレス）',
      'ヘレニズム思想',
      'ユダヤ教・キリスト教',
      'イスラーム教',
      'インド思想（ヒンドゥー教・仏教）',
      '中国思想（儒教・道教）',
      '日本の古代思想'
    ],
    '西洋近現代思想': [
      'ルネサンス・宗教改革',
      '近代哲学（デカルト・カント・ヘーゲル）',
      '功利主義・プラグマティズム',
      '実存主義',
      '現代思想'
    ],
    '現代の諸課題': [
      '生命倫理',
      '環境倫理',
      '情報社会の倫理',
      '国際社会の倫理',
      '現代日本の課題'
    ]
  },
  
  '政治経済': {
    '政治': [
      '民主政治の原理',
      '日本国憲法',
      '基本的人権',
      '統治機構（国会・内閣・裁判所）',
      '地方自治',
      '選挙制度',
      '政党政治',
      '国際政治'
    ],
    '経済': [
      '経済体制',
      '市場経済のしくみ',
      '企業',
      '金融',
      '財政',
      '労働問題',
      '社会保障',
      '国際経済'
    ]
  },
  
  // ========== その他 ==========
  '情報': {
    '情報社会': [
      '情報とメディア',
      '情報モラル',
      '情報セキュリティ',
      '知的財産権',
      '個人情報保護'
    ],
    '情報技術': [
      'コンピュータのしくみ',
      'デジタル表現',
      'ネットワーク',
      'データベース',
      'アルゴリズム',
      'プログラミング基礎',
      'プログラミング応用'
    ]
  }
};

// 難易度別の詳細な特性
const DIFFICULTY_CHARACTERISTICS = {
  easy: {
    name: '基礎（偏差値45-55）',
    description: '教科書の例題・基本問題レベル',
    complexity: 1,
    timeMultiplier: 1,
    conceptDepth: '単一概念の直接適用',
    calculationSteps: '2-3ステップ',
    reasoningDepth: '直接的な論理',
    knowledgeScope: '基本的な知識・公式',
    applicationLevel: '典型的な問題パターン'
  },
  medium: {
    name: '標準（偏差値55-65）',
    description: '入試標準レベル・センター試験レベル',
    complexity: 2,
    timeMultiplier: 1.5,
    conceptDepth: '2-3個の概念の組み合わせ',
    calculationSteps: '4-6ステップ',
    reasoningDepth: '複数段階の論理展開',
    knowledgeScope: '単元内の統合的理解',
    applicationLevel: '応用問題・やや複雑な設定'
  },
  hard: {
    name: '発展（偏差値65-70）',
    description: '難関大学入試レベル',
    complexity: 3,
    timeMultiplier: 2,
    conceptDepth: '複数単元にまたがる統合',
    calculationSteps: '7-10ステップ',
    reasoningDepth: '高度な論理的思考',
    knowledgeScope: '教科全体の深い理解',
    applicationLevel: '非典型的・新規性のある問題'
  },
  expert: {
    name: '最難関（偏差値70-75）',
    description: '最難関大学入試・オリンピックレベル',
    complexity: 4,
    timeMultiplier: 2.5,
    conceptDepth: '創造的な概念の結合',
    calculationSteps: '10ステップ以上',
    reasoningDepth: '独創的な発想と厳密な論証',
    knowledgeScope: '教科を超えた知識の活用',
    applicationLevel: '未知の問題への対応力'
  }
};

// メインのプロンプト生成関数
export const PROMPTS = {
  GENERATE_PROBLEM: (request: GeminiProblemRequest) => {
    const { subject, topic, subtopic, difficulty, type, userProfile, includeCanvas } = request;
    
    // 英語・国語の特別処理
    const isLanguageSubject = ['英語', '現代文', '古文', '漢文'].includes(subject);
    if (isLanguageSubject) {
      const validTopics = subject === '英語' 
        ? ['英文法', '英作文', '長文読解', '単語']
        : ['文法', '読解', '単語'];
      
      if (!validTopics.includes(topic)) {
        return `エラー: ${subject}では以下のトピックのみ選択可能です：${validTopics.join('、')}`;
      }
    }
    
    // subtopicが指定されていない場合、単元内からランダムに選択
    let selectedSubtopic = subtopic;
    let isRandomSelection = false;
    
    if (!subtopic && topic) {
      const topicsInUnit = UNIT_TOPICS_DATABASE[subject]?.[topic];
      if (topicsInUnit && topicsInUnit.length > 0) {
        const randomIndex = Math.floor(Math.random() * topicsInUnit.length);
        selectedSubtopic = topicsInUnit[randomIndex];
        isRandomSelection = true;
      }
    }

    const difficultyInfo = DIFFICULTY_CHARACTERISTICS[difficulty] || DIFFICULTY_CHARACTERISTICS.medium;

    // 問題形式別の出力フォーマットを生成
    const formatSpecification = getFormatSpecification(type);

    return `
あなたは日本の高校教育における全教科の専門家です。
${isRandomSelection ? `単元「${topic}」から「${selectedSubtopic}」をランダムに選択しました。` : ''}
以下の条件で、偏差値75レベルまで完全対応した問題を生成してください。

## 問題生成条件
- 科目: ${subject}
- 単元: ${topic}
- トピック: ${selectedSubtopic || '単元全体から出題'}
- 難易度: ${difficulty} - ${difficultyInfo.name}
- 問題形式: ${type}
${includeCanvas ? '- 図形・グラフを含む（必須）' : ''}

## 難易度「${difficulty}」の詳細要件
- ${difficultyInfo.description}
- 概念の深さ: ${difficultyInfo.conceptDepth}
- 計算ステップ: ${difficultyInfo.calculationSteps}
- 論理的思考: ${difficultyInfo.reasoningDepth}
- 必要知識: ${difficultyInfo.knowledgeScope}
- 応用レベル: ${difficultyInfo.applicationLevel}

${getSubjectSpecificRequirements(subject, topic, selectedSubtopic, difficulty)}

## 問題作成の絶対条件

1. **実際の入試問題と同等以上の品質**
   - 過去の入試問題を研究し、それと同等かそれ以上の問題を作成
   - あいまいさのない明確な問題文
   - 採点基準が明確で客観的

2. **教育的価値の最大化**
   - 単なる知識の確認ではなく、思考力・判断力・表現力を問う
   - 段階的な学習を促す構造
   - 間違いからも学べる設計

3. **完全な解答・解説**
   - 模範解答は論理的に完璧
   - 別解がある場合は必ず提示
   - つまずきやすいポイントの詳細な説明
   - 関連事項や発展的内容への言及

${includeCanvas ? getCanvasSpecificRequirements(subject, topic, selectedSubtopic) : ''}

## 出力形式（重要：以下のJSON形式を厳密に守ること）
${formatSpecification}

必ず上記のJSON形式で出力してください。特に：
- 数式に$記号を使わないこと
- LaTeX形式の数式は使用しないこと（√、×、÷、≤、≥、π などの通常の記号を使用）
- ${type === 'multiple_choice' ? '**"options"フィールドは必須です。必ず4つの選択肢を含めてください。**' : ''}
- 文字列はすべてJSON形式で適切にエスケープすること
`;
  },
};

// ==================== ヘルパー関数 ====================

// 問題形式別の出力フォーマット指定
function getFormatSpecification(type: string): string {
  const baseFormat = `
\`\`\`json
{
  "problems": [{
    "question": "問題文（明確で具体的な指示を含む）",
    "selectedTopic": "選択されたトピック名",
    "isRandomlySelected": true/false,
    "type": "${type}",
    "difficulty": "難易度",
    "estimatedTime": 推定解答時間（分）,
    "points": 配点,`;

  // 問題形式別のフィールド
  let typeSpecificFields = '';
  
  if (type === 'multiple_choice') {
    typeSpecificFields = `
    
    "options": [
      "選択肢1（この中の1つが正解）",
      "選択肢2",
      "選択肢3",
      "選択肢4"
    ],`;
  } else if (type === 'fill_in_blank') {
    typeSpecificFields = `
    
    "blanks": 空欄の数,`;
  } else if (type === 'sequence' || type === 'matching') {
    typeSpecificFields = `
    
    "items": ["項目1", "項目2", "項目3", "項目4"],`;
  }

  const commonFields = `
    
    "answer": {
      "correct": "正解（簡潔な最終解答）",
      "detailed": "完全な解答過程（採点基準を含む）",
      "alternatives": ["別解1", "別解2"]
    },
    
    "explanation": {
      "overview": "問題の意図と学習目標",
      "solution": "詳細な解法説明",
      "keyPoints": ["重要ポイント1", "重要ポイント2"],
      "commonMistakes": [
        {"type": "よくある誤答", "reason": "間違いの原因", "correction": "正しい考え方"}
      ],
      "extensions": "発展的な内容や関連事項"
    },
    
    "hints": [
      {"level": 1, "content": "方針を示すヒント"},
      {"level": 2, "content": "具体的な手法のヒント"},
      {"level": 3, "content": "計算や細部のヒント"}
    ],
    
    "evaluation": {
      "partialCredits": [
        {"criteria": "方針が正しい", "points": 30},
        {"criteria": "途中計算が正しい", "points": 40},
        {"criteria": "最終解答が正しい", "points": 30}
      ],
      "requirements": ["論理性", "正確性", "表現力"]
    },
    
    "metadata": {
      "concepts": ["必要な概念1", "必要な概念2"],
      "prerequisites": ["前提知識1", "前提知識2"],
      "skills": ["必要なスキル1", "必要なスキル2"],
      "realWorldApplication": "実社会での応用例"
    }`;

  const canvasField = `,
    
    "canvasConfig": {
      "type": "図形タイプ",
      "width": 600,
      "height": 400,
      "elements": []
    }`;

  return baseFormat + typeSpecificFields + commonFields + (type === 'multiple_choice' ? '' : '') + `
  }]
}
\`\`\``;
}

// 科目別の詳細要件
function getSubjectSpecificRequirements(subject: string, topic: string, subtopic: string, difficulty: string): string {
  // 数学系
  if (['数学Ⅰ', '数学A', '数学Ⅱ', '数学B', '数学Ⅲ', 'math1', 'mathA', 'math2', 'mathB', 'mathC', 'math3'].includes(subject)) {
    return `
## 数学問題の作成要件
- 論理的厳密性を保つ
- ${difficulty === 'expert' ? '複数の解法が存在し、エレガントな解法を含む' : '標準的な解法で解ける'}
- 計算過程を重視し、答えだけでなく過程も評価対象とする
- ${topic}の本質的理解を問う
- 必要に応じて証明問題や論述問題を含める`;
  }
  
  // 理科系
  if (['物理', '物理基礎', '化学', '化学基礎', '生物', '生物基礎', '地学基礎', 'physicsBase', 'physics', 'chemistryBase', 'chemistry', 'biologyBase', 'biology', 'earthScienceBase', 'earthScience'].includes(subject)) {
    return `
## 理科問題の作成要件
- 現象の本質的理解を問う
- ${difficulty === 'expert' ? '未知の状況への原理の適用' : '典型的な状況での法則の適用'}
- 実験・観察に基づく考察を含める
- グラフ・データの読み取りと分析
- 単位や有効数字に注意`;
  }
  
  // 英語
  if (subject === '英語' || subject === 'englishReading') {
    return getLanguageSpecificRequirements(subject, topic, subtopic, difficulty);
  }
  
  // 国語系
  if (['現代文', '古文', '漢文', 'japanese'].includes(subject)) {
    return getLanguageSpecificRequirements(subject, topic, subtopic, difficulty);
  }
  
  // 社会系
  if (['日本史', '世界史', '地理', '倫理', '政治経済', 'japaneseHistory', 'worldHistory', 'geographyComprehensive', 'geography', 'historyComprehensive', 'civicsBase', 'ethics', 'politicsEconomics'].includes(subject)) {
    return `
## 社会科問題の作成要件
- 単なる暗記ではなく、理解と思考を問う
- ${difficulty === 'expert' ? '複数の視点からの考察や論述' : '基本的な因果関係の理解'}
- 資料（史料・統計・地図等）の読み取り
- 時代背景や地理的条件との関連
- 現代的な課題との接続`;
  }
  
  if (subject === 'information1') {
    return `
## 情報問題の作成要件
- 実践的なプログラミング能力を問う
- アルゴリズムの理解と応用
- データ分析とその解釈
- 情報セキュリティやモラルの理解`;
  }
  
  return '';
}

// 言語系科目（英語・国語）の特別要件
function getLanguageSpecificRequirements(subject: string, topic: string, subtopic: string, difficulty: string): string {
  if (subject === '英語' || subject === 'englishReading') {
    const requirements: any = {
      '英文法': {
        easy: '基本的な文法規則の理解と適用',
        medium: '複雑な文構造での文法の活用',
        hard: '例外的用法や慣用表現を含む高度な文法',
        expert: 'ネイティブレベルの自然な文法感覚'
      },
      '英作文': {
        easy: '50-80語の基本的な英作文',
        medium: '100-150語の論理的な英作文',
        hard: '200-250語の説得力のある英作文',
        expert: '300語以上の学術的な英作文'
      },
      '長文読解': {
        easy: '300-500語の平易な英文',
        medium: '600-800語の標準的な英文',
        hard: '900-1200語の高度な英文',
        expert: '1500語以上の学術論文レベル'
      },
      '単語': {
        easy: '基本2000語レベル',
        medium: '標準4000語レベル',
        hard: '上級6000語レベル',
        expert: '最上級8000語以上'
      }
    };
    
    return `
## 英語「${topic}」の作成要件
- ${requirements[topic]?.[difficulty] || '適切なレベルの問題'}
- 実用的な文脈での出題
- ${topic === '長文読解' ? '多様なジャンル（説明文・論説文・物語文等）' : ''}
- ${topic === '英作文' ? '明確な採点基準（文法・内容・構成）' : ''}`;
  }
  
  if (['現代文', '古文', '漢文', 'japanese'].includes(subject)) {
    const textLength: any = {
      現代文: { easy: '800字', medium: '1500字', hard: '2500字', expert: '4000字' },
      古文: { easy: '200字', medium: '400字', hard: '600字', expert: '800字' },
      漢文: { easy: '50字', medium: '100字', hard: '150字', expert: '200字' }
    };
    
    const subjectName = subject === 'japanese' ? '国語' : subject;
    
    return `
## ${subjectName}「${topic}」の作成要件
- ${topic === '読解' ? `文章の長さ: ${textLength[subjectName]?.[difficulty] || '適切な長さ'}程度` : ''}
- ${subjectName}特有の表現や文体を活かした出題
- ${topic === '文法' ? '実際の文章での用例を重視' : ''}
- ${topic === '単語' ? '文脈での意味理解を重視' : ''}`;
  }
  
  return '';
}

// Canvas設定の詳細要件
function getCanvasSpecificRequirements(subject: string, topic: string, subtopic: string): string {
  const requirements: any = {
    '数学': '座標平面、関数グラフ、幾何図形、ベクトル図など',
    '物理': '力の図示、運動の軌跡、波形、電気回路図など',
    '化学': '分子構造、エネルギー図、反応グラフ、結晶構造など',
    '生物': '細胞図、遺伝系図、生態系図、実験グラフなど',
    '地学': '地層断面図、天体図、気象図、プレート図など'
  };
  
  const subjectBase = subject.replace(/[基礎ⅠⅡⅢ]/g, '').replace(/[1-3ABC]/, '');
  
  return `
## Canvas図形要件
- 図形タイプ: ${requirements[subjectBase] || '適切な図形表現'}
- 問題理解に必須の視覚情報を含む
- インタラクティブ要素で理解を深める
- 解答に必要な情報は図形に含める
- 図形から読み取るべき情報を明確に指示`;
}

// Canvas設定の生成
function getCanvasConfig(subject: string, topic: string, subtopic: string): string {
  const configs: any = {
    '数学': {
      '関数': {
        type: 'coordinate',
        gridSize: 20,
        range: { x: [-10, 10], y: [-10, 10] },
        elements: ['function', 'points', 'areas']
      },
      '図形': {
        type: 'geometry',
        gridSize: 10,
        elements: ['shapes', 'angles', 'lengths']
      },
      'ベクトル': {
        type: 'vector',
        gridSize: 20,
        elements: ['vectors', 'points', 'coordinates']
      }
    },
    '物理': {
      '力学': {
        type: 'physics',
        elements: ['forces', 'trajectory', 'energy']
      },
      '波動': {
        type: 'wave',
        elements: ['waveform', 'interference', 'phase']
      }
    },
    '化学': {
      type: 'chemistry',
      elements: ['molecules', 'energy_diagram', 'reaction']
    }
  };
  
  // デフォルト設定
  const defaultConfig = {
    type: 'general',
    width: 600,
    height: 400,
    gridSize: 20,
    showGrid: true,
    showAxes: true,
    elements: [],
    interactive: true
  };
  
  return JSON.stringify(defaultConfig, null, 2);
}

// 推定解答時間
function getEstimatedTime(subject: string, topic: string, difficulty: string): number {
  const baseTime: any = {
    // 数学
    '計算問題': { easy: 5, medium: 10, hard: 15, expert: 20 },
    '証明問題': { easy: 10, medium: 15, hard: 20, expert: 30 },
    
    // 英語
    '英文法': { easy: 3, medium: 5, hard: 7, expert: 10 },
    '英作文': { easy: 10, medium: 15, hard: 20, expert: 30 },
    '長文読解': { easy: 15, medium: 20, hard: 30, expert: 40 },
    '単語': { easy: 2, medium: 3, hard: 5, expert: 7 },
    
    // 国語
    '文法': { easy: 3, medium: 5, hard: 7, expert: 10 },
    '読解': { easy: 10, medium: 15, hard: 25, expert: 35 },
    '単語': { easy: 2, medium: 3, hard: 5, expert: 7 },
    
    // デフォルト
    'default': { easy: 10, medium: 15, hard: 20, expert: 30 }
  };
  
  return baseTime[topic]?.[difficulty] || baseTime.default[difficulty];
}

// 配点
function getPoints(difficulty: string): number {
  const points: any = {
    easy: 20,
    medium: 30,
    hard: 40,
    expert: 50
  };
  return points[difficulty] || 30;
}